import React, { useState, useMemo } from 'react';
import { 
  BarChart, Bar, LineChart, Line, PieChart, Pie, Cell, XAxis, YAxis, 
  CartesianGrid, Tooltip, Legend, ResponsiveContainer 
} from 'recharts';
import { Calendar, CheckCircle, AlertCircle, BookOpen, Target, Clock, TrendingUp } from 'lucide-react';

// ç¾åœ¨ã®æ—¥ä»˜ã‚’2024å¹´7æœˆ25æ—¥ã¨ã—ã¦è¨­å®š
const getCurrentDate = () => new Date('2024-07-25');
const getExamDate = () => new Date('2024-10-12');
const getStudyEndDate = () => new Date('2024-10-05');

// å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ï¼ˆå¾—ç‚¹åŠ¹ç‡ã¨é‡è¦åº¦ã‚’è€ƒæ…®ï¼‰
const studyData = {
  examName: "å¿œç”¨æƒ…å ±æŠ€è¡“è€…è©¦é¨“",
  examDate: "2024-10-12",
  subjects: [
    { 
      id: 1, 
      name: "åŸºç¤ç†è«–", 
      priority: "ä¸­", 
      difficulty: 3, 
      examWeight: 8, 
      weeks: 3,
      currentWeek: 3,
      status: "å®Œäº†",
      description: "æ•°å­¦ã€è«–ç†æ¼”ç®—ãªã©"
    },
    { 
      id: 2, 
      name: "ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã¨ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°", 
      priority: "é«˜", 
      difficulty: 4, 
      examWeight: 12, 
      weeks: 3,
      currentWeek: 1,
      status: "å­¦ç¿’ä¸­",
      description: "ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã€ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ è¨­è¨ˆ"
    },
    { 
      id: 3, 
      name: "ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã¨ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿æ§‹æˆè¦ç´ ", 
      priority: "ä¸­", 
      difficulty: 2, 
      examWeight: 8, 
      weeks: 3,
      currentWeek: 0,
      status: "æœªé–‹å§‹",
      description: "CPUã€ãƒ¡ãƒ¢ãƒªã€å…¥å‡ºåŠ›è£…ç½®"
    },
    { 
      id: 4, 
      name: "ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆè¦ç´ ", 
      priority: "ä¸­", 
      difficulty: 2, 
      examWeight: 6, 
      weeks: 3,
      currentWeek: 0,
      status: "æœªé–‹å§‹",
      description: "ã‚·ã‚¹ãƒ†ãƒ æ€§èƒ½ã€å¯ç”¨æ€§"
    },
    { 
      id: 5, 
      name: "ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢", 
      priority: "ä¸­", 
      difficulty: 3, 
      examWeight: 8, 
      weeks: 3,
      currentWeek: 0,
      status: "æœªé–‹å§‹",
      description: "OSã€ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ "
    },
    { 
      id: 6, 
      name: "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹", 
      priority: "é«˜", 
      difficulty: 4, 
      examWeight: 15, 
      weeks: 3,
      currentWeek: 0,
      status: "æœªé–‹å§‹",
      description: "é–¢ä¿‚ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã€SQLã€æ­£è¦åŒ–"
    },
    { 
      id: 7, 
      name: "ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯", 
      priority: "é«˜", 
      difficulty: 3, 
      examWeight: 12, 
      weeks: 3,
      currentWeek: 0,
      status: "æœªé–‹å§‹",
      description: "TCP/IPã€ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã€ãƒ—ãƒ­ãƒˆã‚³ãƒ«"
    },
    { 
      id: 8, 
      name: "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£", 
      priority: "é«˜", 
      difficulty: 3, 
      examWeight: 15, 
      weeks: 3,
      currentWeek: 0,
      status: "æœªé–‹å§‹",
      description: "æš—å·åŒ–ã€èªè¨¼ã€æƒ…å ±ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–"
    },
    { 
      id: 9, 
      name: "ã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºæŠ€è¡“", 
      priority: "ä¸­", 
      difficulty: 2, 
      examWeight: 8, 
      weeks: 3,
      currentWeek: 0,
      status: "æœªé–‹å§‹",
      description: "é–‹ç™ºãƒ—ãƒ­ã‚»ã‚¹ã€ãƒ†ã‚¹ãƒˆæ‰‹æ³•"
    },
    { 
      id: 10, 
      name: "ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆ", 
      priority: "ä½", 
      difficulty: 2, 
      examWeight: 4, 
      weeks: 3,
      currentWeek: 0,
      status: "æœªé–‹å§‹",
      description: "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†ã€å“è³ªç®¡ç†"
    },
    { 
      id: 11, 
      name: "ã‚¹ãƒˆãƒ©ãƒ†ã‚¸", 
      priority: "ä½", 
      difficulty: 2, 
      examWeight: 4, 
      weeks: 3,
      currentWeek: 0,
      status: "æœªé–‹å§‹",
      description: "çµŒå–¶æˆ¦ç•¥ã€ã‚·ã‚¹ãƒ†ãƒ æˆ¦ç•¥"
    }
  ],
  phases: [
    { name: "1é€±ç›®: ã‚¤ãƒ³ãƒ—ãƒƒãƒˆ", description: "åŸºç¤çŸ¥è­˜ã®ç¿’å¾—" },
    { name: "2é€±ç›®: å¾©ç¿’", description: "ç†è§£ã®å®šç€ã¨å•é¡Œæ¼”ç¿’" },
    { name: "3é€±ç›®: åˆå¾Œè©¦é¨“å¯¾ç­–", description: "å¿œç”¨å•é¡Œã¨è¨˜è¿°å¯¾ç­–" }
  ]
};

const StudyPlanDashboard = () => {
  const [subjects, setSubjects] = useState(studyData.subjects);
  const [filter, setFilter] = useState({ priority: "", status: "" });
  const [activeTimer, setActiveTimer] = useState(null);
  const [timerStart, setTimerStart] = useState(null);
  const [elapsedTime, setElapsedTime] = useState(0);
  const [studyTimes, setStudyTimes] = useState({});

  // ã‚¿ã‚¤ãƒãƒ¼æ›´æ–°
  React.useEffect(() => {
    let interval;
    if (activeTimer && timerStart) {
      interval = setInterval(() => {
        setElapsedTime(Date.now() - timerStart);
      }, 1000);
    }
    return () => clearInterval(interval);
  }, [activeTimer, timerStart]);

  // ç¾åœ¨ã®æ—¥ä»˜ã‹ã‚‰å­¦ç¿’çµ‚äº†æ—¥ã¾ã§ã®æ®‹ã‚Šæ—¥æ•°ã‚’è¨ˆç®—
  const daysUntilStudyEnd = useMemo(() => {
    const today = getCurrentDate();
    const studyEndDate = getStudyEndDate();
    const diffTime = studyEndDate - today;
    return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  }, []);

  const daysUntilExam = useMemo(() => {
    const today = getCurrentDate();
    const examDate = getExamDate();
    const diffTime = examDate - today;
    return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  }, []);

  // åˆ©ç”¨å¯èƒ½ãªå­¦ç¿’é€±æ•°ã‚’è¨ˆç®—ï¼ˆ10æœˆ5æ—¥ã¾ã§ï¼‰
  const availableWeeks = Math.floor(daysUntilStudyEnd / 7);
  const totalRequiredWeeks = 11 * 3; // 11ç§‘ç›® Ã— 3é€±é–“ = 33é€±é–“
  const compressionRatio = availableWeeks / totalRequiredWeeks;

  // å…¨ä½“ã®é€²æ—è¨ˆç®—
  const overallProgress = useMemo(() => {
    const totalWeeks = subjects.length * 3; // å„ç§‘ç›®3é€±é–“
    const completedWeeks = subjects.reduce((total, subject) => total + subject.currentWeek, 0);
    return Math.round((completedWeeks / totalWeeks) * 100);
  }, [subjects]);

  // å„ªå…ˆåº¦åˆ¥ã®ç§‘ç›®æ•°
  const priorityDistribution = useMemo(() => {
    const distribution = { "é«˜": 0, "ä¸­": 0, "ä½": 0 };
    subjects.forEach(subject => {
      distribution[subject.priority]++;
    });
    return Object.entries(distribution).map(([priority, count]) => ({
      name: priority,
      value: count,
      color: priority === "é«˜" ? "#ef4444" : priority === "ä¸­" ? "#f59e0b" : "#22c55e"
    }));
  }, [subjects]);

  // å¾—ç‚¹åŠ¹ç‡é †ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°
  const efficiencyRanking = useMemo(() => {
    return [...subjects]
      .sort((a, b) => (b.examWeight / b.difficulty) - (a.examWeight / a.difficulty))
      .slice(0, 5)
      .map((subject, index) => ({
        ...subject,
        rank: index + 1,
        efficiency: Math.round((subject.examWeight / subject.difficulty) * 10) / 10
      }));
  }, [subjects]);

  // å­¦ç¿’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆ10æœˆ5æ—¥å®Œäº†ã«å‘ã‘ãŸæ™‚é–“åœ§ç¸®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼‰
  const optimizedSchedule = useMemo(() => {
    const schedule = [];
    let currentWeek = 1;
    
    // æŒ‡å®šã•ã‚ŒãŸç§‘ç›®é †åº
    const subjectOrder = [
      "åŸºç¤ç†è«–",
      "ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã¨ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°", 
      "ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã¨ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿æ§‹æˆè¦ç´ ",
      "ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆè¦ç´ ",
      "ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢",
      "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹",
      "ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯",
      "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£",
      "ã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºæŠ€è¡“",
      "ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆ",
      "ã‚¹ãƒˆãƒ©ãƒ†ã‚¸"
    ];

    // ç§‘ç›®é †ã«ã‚½ãƒ¼ãƒˆ
    const sortedSubjects = subjectOrder.map(subjectName => 
      subjects.find(s => s.name === subjectName)
    ).filter(Boolean);

    // æ™‚é–“åœ§ç¸®ã«ã‚ˆã‚‹å­¦ç¿’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆå…¨ç§‘ç›®3ãƒ•ã‚§ãƒ¼ã‚ºç¶­æŒï¼‰
    const phaseNames = ["ã‚¤ãƒ³ãƒ—ãƒƒãƒˆ", "å¾©ç¿’", "åˆå¾Œå¯¾ç­–"];
    // åœ§ç¸®ç‡ã‚’é©ç”¨ã—ãŸæ™‚é–“é‡ã¿ã¥ã‘
    const studyTimeWeights = [
      0.7 * compressionRatio,  // ã‚¤ãƒ³ãƒ—ãƒƒãƒˆ: å¤§å¹…åœ§ç¸®
      0.4 * compressionRatio,  // å¾©ç¿’: ã•ã‚‰ã«åœ§ç¸®
      0.8 * compressionRatio   // åˆå¾Œå¯¾ç­–: æ¯”è¼ƒçš„ç¶­æŒ
    ];

    // å„ãƒ•ã‚§ãƒ¼ã‚ºã”ã¨ã«å…¨ç§‘ç›®ã‚’å®Ÿè¡Œ
    for (let phase = 1; phase <= 3; phase++) {
      sortedSubjects.forEach(subject => {
        const baseHours = subject.examWeight * 2; // åŸºæœ¬å­¦ç¿’æ™‚é–“ï¼ˆé…ç‚¹Ã—2æ™‚é–“ï¼‰
        const adjustedHours = Math.max(
          Math.round(baseHours * studyTimeWeights[phase - 1]),
          phase === 1 ? 4 : 2 // æœ€ä½å­¦ç¿’æ™‚é–“ã®ä¿è¨¼
        );
        
        // 10æœˆ5æ—¥å®Œäº†ã«å‘ã‘ãŸé€±æ•°èª¿æ•´
        const totalTasksNeeded = 33; // 11ç§‘ç›® Ã— 3ãƒ•ã‚§ãƒ¼ã‚º
        const weeksAvailable = Math.floor(daysUntilStudyEnd / 7);
        const adjustedWeek = Math.min(currentWeek, weeksAvailable);
        
        // é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’è¨ˆç®—ï¼ˆ10æœˆ5æ—¥ä»¥å†…ã«åã¾ã‚‹ã‚ˆã†èª¿æ•´ï¼‰
        const daysPerTask = Math.floor(daysUntilStudyEnd / totalTasksNeeded);
        const startDate = new Date(2024, 6, 25 + (currentWeek - 1) * daysPerTask);
        const endDate = new Date(2024, 6, 25 + currentWeek * daysPerTask - 1);
        
        // 10æœˆ5æ—¥ã‚’è¶…ãˆãªã„ã‚ˆã†èª¿æ•´
        const studyEndDate = getStudyEndDate();
        const actualEndDate = endDate > studyEndDate ? studyEndDate : endDate;
        
        const taskId = `${subject.name}-${phase}`;
        const actualStudyTime = studyTimes[taskId] || 0;
        const remainingTime = Math.max(0, Math.min(adjustedHours, 35) - actualStudyTime);
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¤å®šã®ä¿®æ­£
        let status;
        if (subject.currentWeek > phase) {
          status = "å®Œäº†";
        } else if (subject.currentWeek === phase) {
          status = actualEndDate < new Date() ? "å®Œäº†" : "é€²è¡Œä¸­";
        } else {
          status = startDate <= new Date() && new Date() <= actualEndDate ? "é€²è¡Œä¸­" : "äºˆå®š";
        }
        
        schedule.push({
          id: taskId,
          week: currentWeek,
          subject: subject.name,
          phase: `${phase}é€±ç›®: ${phaseNames[phase - 1]}`,
          priority: subject.priority,
          studyHours: Math.min(adjustedHours, 35), // é€±35æ™‚é–“ä¸Šé™
          actualStudyTime: actualStudyTime,
          remainingTime: remainingTime,
          originalHours: Math.round(baseHours * [1.0, 0.8, 1.2][phase - 1]),
          efficiency: Math.round((subject.examWeight / subject.difficulty) * 10) / 10,
          status: status,
          startDate: startDate.toLocaleDateString('ja-JP'),
          endDate: actualEndDate.toLocaleDateString('ja-JP'),
          compressionRatio: Math.round(studyTimeWeights[phase - 1] / [1.0, 0.8, 1.2][phase - 1] * 100)
        });
        currentWeek++;
      });
    }

    return schedule;
  }, [subjects, compressionRatio, studyTimes, daysUntilStudyEnd]);

  // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
  const filteredSubjects = useMemo(() => {
    return subjects.filter(subject => {
      return (
        (filter.priority === "" || subject.priority === filter.priority) &&
        (filter.status === "" || subject.status === filter.status)
      );
    });
  }, [subjects, filter]);

  const updateSubjectProgress = (subjectId, newWeek) => {
    setSubjects(prev => prev.map(subject => 
      subject.id === subjectId 
        ? { 
            ...subject, 
            currentWeek: newWeek,
            status: newWeek === 0 ? "æœªé–‹å§‹" : newWeek >= 1 ? "å®Œäº†" : "å­¦ç¿’ä¸­"
          }
        : subject
    ));
  };

  // ã‚¿ã‚¤ãƒãƒ¼æ©Ÿèƒ½
  const startTimer = (taskId) => {
    if (activeTimer === taskId) {
      // ã‚¿ã‚¤ãƒãƒ¼åœæ­¢
      if (timerStart) {
        const totalTime = Math.floor((Date.now() - timerStart) / 60000); // åˆ†å˜ä½
        setStudyTimes(prev => ({
          ...prev,
          [taskId]: (prev[taskId] || 0) + totalTime/60 // æ™‚é–“å˜ä½ã§ä¿å­˜
        }));
      }
      setActiveTimer(null);
      setTimerStart(null);
      setElapsedTime(0);
    } else {
      // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
      setActiveTimer(taskId);
      setTimerStart(Date.now());
      setElapsedTime(0);
    }
  };

  const formatTime = (milliseconds) => {
    const minutes = Math.floor(milliseconds / 60000);
    const seconds = Math.floor((milliseconds % 60000) / 1000);
    return `${minutes}:${seconds.toString().padStart(2, '0')}`;
  };

  const formatHours = (hours) => {
    return Math.round(hours * 10) / 10;
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-8">
      {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
      <div className="bg-white rounded-xl shadow-lg border border-blue-200 p-6 mb-8">
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-3xl font-bold text-gray-800 flex items-center">
              <BookOpen className="w-8 h-8 mr-3 text-blue-600" />
              {studyData.examName} å­¦ç¿’è¨ˆç”»
            </h1>
            <p className="text-gray-600 mt-2">å­¦ç¿’çµ‚äº†: 2024å¹´10æœˆ5æ—¥ (æ®‹ã‚Š{daysUntilStudyEnd}æ—¥) | è©¦é¨“æ—¥: {studyData.examDate} (æ®‹ã‚Š{daysUntilExam}æ—¥)</p>
          </div>
          <div className="text-right">
            <div className="text-2xl font-bold text-blue-600">{overallProgress}%</div>
            <div className="text-sm text-gray-500">å…¨ä½“é€²æ—</div>
          </div>
        </div>
      </div>

      {/* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */}
      <div className="bg-white rounded-xl shadow-lg border border-blue-200 p-4 mb-8">
        <div className="flex flex-wrap gap-4">
          <select 
            className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
            value={filter.priority}
            onChange={(e) => setFilter({...filter, priority: e.target.value})}
          >
            <option value="">å…¨ã¦ã®å„ªå…ˆåº¦</option>
            <option value="é«˜">é«˜å„ªå…ˆåº¦</option>
            <option value="ä¸­">ä¸­å„ªå…ˆåº¦</option>
            <option value="ä½">ä½å„ªå…ˆåº¦</option>
          </select>
          
          <select 
            className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
            value={filter.status}
            onChange={(e) => setFilter({...filter, status: e.target.value})}
          >
            <option value="">å…¨ã¦ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</option>
            <option value="å®Œäº†">å®Œäº†</option>
            <option value="å­¦ç¿’ä¸­">å­¦ç¿’ä¸­</option>
            <option value="æœªé–‹å§‹">æœªé–‹å§‹</option>
          </select>
        </div>
      </div>

      {/* ã‚­ãƒ¼ãƒ¡ãƒˆãƒªã‚¯ã‚¹ */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div className="bg-white rounded-xl shadow-lg border border-green-200 p-6">
          <div className="flex items-center justify-between mb-4">
            <h3 className="text-sm font-medium text-gray-600">å®Œäº†ç§‘ç›®æ•°</h3>
            <CheckCircle className="w-5 h-5 text-green-500" />
          </div>
          <div className="text-2xl font-bold text-gray-800">
            {subjects.filter(s => s.status === "å®Œäº†").length}
          </div>
          <div className="text-sm text-gray-500">/ {subjects.length} ç§‘ç›®</div>
        </div>

        <div className="bg-white rounded-xl shadow-lg border border-blue-200 p-6">
          <div className="flex items-center justify-between mb-4">
            <h3 className="text-sm font-medium text-gray-600">å­¦ç¿’ä¸­ç§‘ç›®æ•°</h3>
            <Target className="w-5 h-5 text-blue-500" />
          </div>
          <div className="text-2xl font-bold text-gray-800">
            {subjects.filter(s => s.status === "å­¦ç¿’ä¸­").length}
          </div>
          <div className="text-sm text-gray-500">é€²è¡Œä¸­</div>
        </div>

        <div className="bg-white rounded-xl shadow-lg border border-orange-200 p-6">
          <div className="flex items-center justify-between mb-4">
            <h3 className="text-sm font-medium text-gray-600">é«˜å„ªå…ˆåº¦ç§‘ç›®</h3>
            <AlertCircle className="w-5 h-5 text-orange-500" />
          </div>
          <div className="text-2xl font-bold text-gray-800">
            {subjects.filter(s => s.priority === "é«˜").length}
          </div>
          <div className="text-sm text-gray-500">é‡ç‚¹ç§‘ç›®</div>
        </div>

        <div className="bg-white rounded-xl shadow-lg border border-purple-200 p-6">
          <div className="flex items-center justify-between mb-4">
            <h3 className="text-sm font-medium text-gray-600">å­¦ç¿’çµ‚äº†ã¾ã§</h3>
            <Clock className="w-5 h-5 text-purple-500" />
          </div>
          <div className="text-2xl font-bold text-gray-800">{daysUntilStudyEnd}</div>
          <div className="text-sm text-gray-500">æ—¥ï¼ˆ10æœˆ5æ—¥ã¾ã§ï¼‰</div>
        </div>
      </div>

      {/* å¾—ç‚¹åŠ¹ç‡ãƒ©ãƒ³ã‚­ãƒ³ã‚° */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <div className="bg-white rounded-xl shadow-lg border border-blue-200 p-6">
          <h2 className="text-lg font-semibold text-gray-800 mb-4 flex items-center">
            <TrendingUp className="w-5 h-5 mr-2 text-green-500" />
            å¾—ç‚¹åŠ¹ç‡ãƒ©ãƒ³ã‚­ãƒ³ã‚° TOP5
          </h2>
          <div className="space-y-3">
            {efficiencyRanking.map(subject => (
              <div key={subject.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                <div className="flex items-center">
                  <span className="w-6 h-6 bg-blue-500 text-white text-xs rounded-full flex items-center justify-center mr-3">
                    {subject.rank}
                  </span>
                  <div>
                    <h4 className="font-medium text-gray-800">{subject.name}</h4>
                    <p className="text-sm text-gray-500">é…ç‚¹: {subject.examWeight}% / é›£æ˜“åº¦: {subject.difficulty}</p>
                  </div>
                </div>
                <div className="text-right">
                  <div className="font-bold text-green-600">{subject.efficiency}</div>
                  <div className="text-xs text-gray-500">åŠ¹ç‡å€¤</div>
                </div>
              </div>
            ))}
          </div>
        </div>

        <div className="bg-white rounded-xl shadow-lg border border-blue-200 p-6">
          <h2 className="text-lg font-semibold text-gray-800 mb-4">å„ªå…ˆåº¦åˆ†å¸ƒ</h2>
          <ResponsiveContainer width="100%" height={250}>
            <PieChart>
              <Pie
                data={priorityDistribution}
                cx="50%"
                cy="50%"
                outerRadius={80}
                dataKey="value"
                label={({name, value}) => `${name}: ${value}`}
              >
                {priorityDistribution.map((entry, index) => (
                  <Cell key={`cell-${index}`} fill={entry.color} />
                ))}
              </Pie>
              <Tooltip />
            </PieChart>
          </ResponsiveContainer>
        </div>
      </div>

      {/* å­¦ç¿’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« */}
      <div className="bg-white rounded-xl shadow-lg border border-blue-200 p-6 mb-8">
        <h2 className="text-lg font-semibold text-gray-800 mb-4">å­¦ç¿’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆ10æœˆ5æ—¥å®Œäº†ç›®æ¨™ - æ™‚é–“åœ§ç¸®ç‰ˆï¼‰</h2>
        
        {/* æ™‚é–“åœ§ç¸®ã®èª¬æ˜ */}
        <div className="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
          <h3 className="font-semibold text-blue-800 mb-2">â° å­¦ç¿’æ™‚é–“åœ§ç¸®ã‚·ã‚¹ãƒ†ãƒ </h3>
          <div className="text-sm text-blue-700">
            <p>â€¢ åˆ©ç”¨å¯èƒ½é€±æ•°: {availableWeeks}é€± / æ¨™æº–å¿…è¦é€±æ•°: {totalRequiredWeeks}é€±</p>
            <p>â€¢ <strong>å…¨ç§‘ç›®3ãƒ•ã‚§ãƒ¼ã‚ºå®Ÿæ–½</strong>ï¼ˆç§‘ç›®å‰Šæ¸›ãªã—ï¼‰</p>
            <p>â€¢ åœ§ç¸®ç‡: {Math.round(compressionRatio * 100)}% - å­¦ç¿’æ™‚é–“ã‚’åŠ¹ç‡åŒ–ã—ã¦çŸ­ç¸®</p>
            <p>â€¢ é€±é–“ä¸Šé™: 35æ™‚é–“ï¼ˆå¹³æ—¥5æ™‚é–“ã€åœŸæ—¥7.5æ™‚é–“æƒ³å®šï¼‰</p>
          </div>
        </div>

        <div className="mb-4 p-4 bg-green-50 rounded-lg">
          <h3 className="font-semibold text-green-800 mb-2">æ™‚é–“åœ§ç¸®ã®é‡ã¿ã¥ã‘</h3>
          <div className="text-sm text-green-700 grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <p><strong>1é€±ç›®ï¼ˆã‚¤ãƒ³ãƒ—ãƒƒãƒˆï¼‰</strong></p>
              <p>é€šå¸¸â†’åœ§ç¸®: ç´„{Math.round(0.7 * compressionRatio * 100)}%</p>
              <p>é‡è¦ãƒã‚¤ãƒ³ãƒˆã«çµã£ãŸå­¦ç¿’</p>
            </div>
            <div>
              <p><strong>2é€±ç›®ï¼ˆå¾©ç¿’ï¼‰</strong></p>
              <p>é€šå¸¸â†’åœ§ç¸®: ç´„{Math.round(0.4 * compressionRatio * 100)}%</p>
              <p>å•é¡Œæ¼”ç¿’ä¸­å¿ƒã®åŠ¹ç‡å­¦ç¿’</p>
            </div>
            <div>
              <p><strong>3é€±ç›®ï¼ˆåˆå¾Œå¯¾ç­–ï¼‰</strong></p>
              <p>é€šå¸¸â†’åœ§ç¸®: ç´„{Math.round(0.8 * compressionRatio * 100)}%</p>
              <p>å®Ÿæˆ¦å½¢å¼ã§æ¯”è¼ƒçš„æ™‚é–“ç¢ºä¿</p>
            </div>
          </div>
        </div>

        <div className="overflow-x-auto">
          <table className="w-full text-sm">
            <thead>
              <tr className="border-b">
                <th className="text-left py-2 px-4">é€±</th>
                <th className="text-left py-2 px-4">ç§‘ç›®</th>
                <th className="text-left py-2 px-4">ãƒ•ã‚§ãƒ¼ã‚º</th>
                <th className="text-left py-2 px-4">å­¦ç¿’ã‚¿ã‚¤ãƒãƒ¼</th>
                <th className="text-left py-2 px-4">é€²æ—æ™‚é–“</th>
                <th className="text-left py-2 px-4">æ®‹ã‚Šæ™‚é–“</th>
                <th className="text-left py-2 px-4">ç›®æ¨™æ™‚é–“</th>
                <th className="text-left py-2 px-4">å„ªå…ˆåº¦</th>
                <th className="text-left py-2 px-4">æœŸé–“</th>
                <th className="text-left py-2 px-4">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
              </tr>
            </thead>
            <tbody>
              {optimizedSchedule.map((item, index) => (
                <tr key={index} className={`border-b ${
                  item.status === "å®Œäº†" ? "bg-green-50" : 
                  item.status === "é€²è¡Œä¸­" ? "bg-blue-50" : ""
                }`}>
                  <td className="py-2 px-4 font-medium">{item.week}</td>
                  <td className="py-2 px-4">{item.subject}</td>
                  <td className="py-2 px-4">{item.phase}</td>
                  <td className="py-2 px-4">
                    <div className="flex flex-col items-center gap-1">
                      <button
                        onClick={() => startTimer(item.id)}
                        className={`px-3 py-1 text-xs rounded-full font-medium ${
                          activeTimer === item.id 
                            ? "bg-red-500 text-white" 
                            : "bg-green-500 text-white hover:bg-green-600"
                        }`}
                        disabled={item.status === "å®Œäº†"}
                      >
                        {activeTimer === item.id ? "åœæ­¢" : "é–‹å§‹"}
                      </button>
                      {activeTimer === item.id && (
                        <div className="text-xs text-blue-600 font-mono">
                          {formatTime(elapsedTime)}
                        </div>
                      )}
                    </div>
                  </td>
                  <td className="py-2 px-4 font-medium text-blue-600">
                    {formatHours(item.actualStudyTime)}h
                  </td>
                  <td className="py-2 px-4 font-medium text-orange-600">
                    {formatHours(item.remainingTime)}h
                  </td>
                  <td className="py-2 px-4 font-medium text-purple-600">{item.studyHours}h</td>
                  <td className="py-2 px-4">
                    <span className={`px-2 py-1 text-xs rounded ${
                      item.priority === "é«˜" ? "bg-red-100 text-red-800" :
                      item.priority === "ä¸­" ? "bg-yellow-100 text-yellow-800" :
                      "bg-green-100 text-green-800"
                    }`}>
                      {item.priority}
                    </span>
                  </td>
                  <td className="py-2 px-4 text-gray-600 text-xs">{item.startDate} - {item.endDate}</td>
                  <td className="py-2 px-4">
                    <span className={`px-2 py-1 text-xs rounded ${
                      item.status === "å®Œäº†" ? "bg-green-100 text-green-800" :
                      item.status === "é€²è¡Œä¸­" ? "bg-blue-100 text-blue-800" :
                      "bg-gray-100 text-gray-800"
                    }`}>
                      {item.status}
                    </span>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
        
        {/* å­¦ç¿’å®Œäº†æ—¥ã®è¡¨ç¤º */}
        <div className="mt-4 p-4 bg-green-50 border border-green-200 rounded-lg">
          <h3 className="font-semibold text-green-800">ğŸ“… å­¦ç¿’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ¦‚è¦</h3>
          <div className="text-sm text-green-700 mt-1 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <p><strong>å…¨å­¦ç¿’å®Œäº†:</strong> 2024å¹´10æœˆ5æ—¥</p>
              <p><strong>ç·å­¦ç¿’é€±æ•°:</strong> {optimizedSchedule.length}é€±é–“</p>
            </div>
            <div>
              <p><strong>è©¦é¨“æ—¥:</strong> 2024å¹´10æœˆ12æ—¥</p>
              <p><strong>æœ€çµ‚å¾©ç¿’æœŸé–“:</strong> 1é€±é–“ç¢ºä¿</p>
            </div>
          </div>
        </div>
      </div>

      {/* ç§‘ç›®åˆ¥è©³ç´° */}
      <div className="bg-white rounded-xl shadow-lg border border-blue-200 p-6">
        <h2 className="text-lg font-semibold text-gray-800 mb-4">ç§‘ç›®åˆ¥å­¦ç¿’çŠ¶æ³</h2>
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {filteredSubjects.map(subject => (
            <div key={subject.id} className="border border-gray-200 rounded-lg p-4">
              <div className="flex items-center justify-between mb-2">
                <h3 className="font-medium text-gray-800">{subject.name}</h3>
                <span className={`px-2 py-1 text-xs rounded ${
                  subject.priority === "é«˜" ? "bg-red-100 text-red-800" :
                  subject.priority === "ä¸­" ? "bg-yellow-100 text-yellow-800" :
                  "bg-green-100 text-green-800"
                }`}>
                  {subject.priority}
                </span>
              </div>
              <p className="text-sm text-gray-600 mb-3">{subject.description}</p>
              <div className="flex items-center justify-between text-sm text-gray-500 mb-3">
                <span>é…ç‚¹: {subject.examWeight}%</span>
                <span>é›£æ˜“åº¦: {subject.difficulty}/5</span>
              </div>
              <div className="mb-3">
                <div className="flex justify-between text-sm mb-1">
                  <span>é€²æ—</span>
                  <span>{Math.round((subject.currentWeek / 3) * 100)}%</span>
                </div>
                <div className="w-full bg-gray-200 rounded-full h-2">
                  <div 
                    className="bg-blue-500 h-2 rounded-full"
                    style={{width: `${(subject.currentWeek / 3) * 100}%`}}
                  ></div>
                </div>
              </div>
              <div className="flex gap-2">
                {[1, 2, 3].map(week => (
                  <button
                    key={week}
                    onClick={() => updateSubjectProgress(subject.id, week)}
                    className={`flex-1 py-1 px-2 text-xs rounded ${
                      subject.currentWeek >= week 
                        ? "bg-green-500 text-white" 
                        : "bg-gray-200 text-gray-600 hover:bg-gray-300"
                    }`}
                  >
                    {week === 1 ? "å®Œäº†" : `${week}é€±ç›®`}
                  </button>
                ))}
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
};

export default StudyPlanDashboard;
